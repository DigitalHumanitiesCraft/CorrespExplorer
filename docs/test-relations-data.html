<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Relations Data Test</title>
    <style>
        body { font-family: system-ui; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .success { color: green; }
        .error { color: red; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f5f5f5; }
        .badge { padding: 2px 8px; border-radius: 3px; font-size: 12px; color: white; }
        .badge-familie { background: #e63946; }
        .badge-beruflich { background: #06a77d; }
        .badge-sozial { background: #f77f00; }
    </style>
</head>
<body>
    <h1>Relations Data Integration Test</h1>
    <div id="results"></div>

    <script type="module">
        import { loadPersons } from './js/data.js';
        import { getPersonConnections } from './js/network-utils.js';

        const results = document.getElementById('results');

        async function runTests() {
            try {
                // Test 1: Load data
                results.innerHTML += '<h2>Test 1: Load Data</h2>';
                const data = await loadPersons();
                results.innerHTML += `<p class="success">Loaded ${data.persons.length} persons</p>`;

                // Test 2: Find persons with relations
                results.innerHTML += '<h2>Test 2: Persons with Relations</h2>';
                const personsWithRelations = data.persons.filter(p => p.relations && p.relations.length > 0);
                results.innerHTML += `<p class="success">Found ${personsWithRelations.length} persons with relations</p>`;

                // Test 3: Category breakdown
                results.innerHTML += '<h2>Test 3: Relations by Category</h2>';
                const categories = { Familie: 0, Beruflich: 0, Sozial: 0 };
                personsWithRelations.forEach(person => {
                    person.relations.forEach(rel => {
                        const target = data.persons.find(p => p.id === rel.target);
                        if (!target) return;

                        // Use network-utils to get category
                        const connections = getPersonConnections(person, data.persons);
                        connections.forEach(conn => {
                            categories[conn.category] = (categories[conn.category] || 0) + 1;
                        });
                    });
                });

                let catTable = '<table><tr><th>Category</th><th>Count</th></tr>';
                Object.entries(categories).forEach(([cat, count]) => {
                    catTable += `<tr><td><span class="badge badge-${cat.toLowerCase()}">${cat}</span></td><td>${count}</td></tr>`;
                });
                catTable += '</table>';
                results.innerHTML += catTable;

                // Test 4: Testable connections (both persons have places)
                results.innerHTML += '<h2>Test 4: Geo-Located Connections</h2>';
                const testable = personsWithRelations.filter(person => {
                    if (!person.places || person.places.length === 0) return false;
                    return person.relations.some(rel => {
                        const target = data.persons.find(p => p.id === rel.target);
                        return target && target.places && target.places.length > 0;
                    });
                });
                results.innerHTML += `<p class="success">Found ${testable.length} persons with geo-located connections</p>`;

                // Test 5: Show examples
                results.innerHTML += '<h2>Test 5: Example Connections</h2>';
                let examplesTable = '<table><tr><th>Person</th><th>Location</th><th>Relation</th><th>Target</th><th>Target Location</th></tr>';

                testable.slice(0, 10).forEach(person => {
                    const connections = getPersonConnections(person, data.persons);
                    if (connections.length > 0) {
                        const conn = connections[0];
                        examplesTable += `<tr>
                            <td>${person.name}</td>
                            <td>${conn.from.name}</td>
                            <td><span class="badge badge-${conn.category.toLowerCase()}">${conn.subtype}</span></td>
                            <td>${conn.person.name}</td>
                            <td>${conn.to.name}</td>
                        </tr>`;
                    }
                });
                examplesTable += '</table>';
                results.innerHTML += examplesTable;

                results.innerHTML += '<h2 class="success">All Tests Passed</h2>';
                results.innerHTML += '<p>The main application should now show network connections on hover.</p>';
                results.innerHTML += '<p><a href="index.html">Open Main Application</a></p>';

            } catch (error) {
                results.innerHTML += `<h2 class="error">Error</h2><pre>${error.stack}</pre>`;
            }
        }

        runTests();
    </script>
</body>
</html>
